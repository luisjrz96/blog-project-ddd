  services:

    traefik:
      image: traefik:v3.1
      command:
        - --api.insecure=true
        - --providers.docker=true
        - --providers.docker.exposedbydefault=false
        - --entrypoints.web.address=:80
        - --entrypoints.pg.address=:5432

      ports:
        - "8081:80"
        - "8089:8080"
        - "5432:5432"
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock:ro
      networks: [appnet]

    keycloak:
      image: quay.io/keycloak/keycloak:26.0
      command: ["start-dev", "--import-realm"]
      environment:
        KC_BOOTSTRAP_ADMIN_USERNAME: ${KC_BOOTSTRAP_ADMIN_USERNAME}
        KC_BOOTSTRAP_ADMIN_PASSWORD: ${KC_BOOTSTRAP_ADMIN_PASSWORD}
        KC_HTTP_ENABLED: "true"
        KC_PROXY: "edge"
        KC_HOSTNAME: "auth.localtest.me"
        KC_HOSTNAME_STRICT: "false"
        KC_DB: postgres
        KC_DB_URL_HOST: postgres
        KC_DB_URL_DATABASE: keycloak
        KC_DB_USERNAME: ${KC_DB_USERNAME}
        KC_DB_PASSWORD: ${KC_DB_PASSWORD}
        KC_DB_URL_PORT: "5432"
      volumes:
        - ./.data/keycloak:/opt/keycloak/data
        - ./docker/init/keycloak:/opt/keycloak/data/import:ro
      restart: always
      labels:
        - traefik.enable=true
        - traefik.http.routers.keycloak.rule=Host(`auth.localtest.me`)
        - traefik.http.routers.keycloak.entrypoints=web
        - traefik.http.services.keycloak.loadbalancer.server.port=8080
      networks: [appnet]
      depends_on:
        - postgres
        - traefik

    postgres:
      image: postgres:16
      restart: always
      environment:
        POSTGRES_DB: ${DEFAULT_DB}
        POSTGRES_USER: ${POSTGRES_USER}
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      volumes:
        - ./.data/postgres:/var/lib/postgresql/data
        - ./docker/postgres/init:/docker-entrypoint-initdb.d
      labels:
        - traefik.enable=true
        - traefik.tcp.routers.postgres.rule=HostSNI(`*`)
        - traefik.tcp.routers.postgres.entrypoints=pg
        - traefik.tcp.services.postgres.loadbalancer.server.port=5432
      networks: [appnet]

    pgadmin:
      image: dpage/pgadmin4:8
      restart: always
      environment:
        PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
        PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
      ports:
        - "8082:80"
      depends_on:
        - postgres
      networks: [appnet]

    prometheus:
      image: prom/prometheus
      volumes:
        - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml
      ports:
        - "9090:9090"
      networks: [appnet]

    tempo:
      image: grafana/tempo
      volumes:
        - ./observability/tempo.yml:/etc/tempo.yml
      command: ["-config.file=/etc/tempo.yml"]
      ports:
        - "3200:3200"
      depends_on:
        - otel-collector
      networks: [appnet]

    grafana:
      image: grafana/grafana
      ports:
        - "3000:3000"
      environment:
        GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER}
        GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
      volumes:
          - ./observability/grafana/provisioning:/etc/grafana/provisioning
          - ./observability/grafana/data:/var/lib/grafana
      depends_on:
        - prometheus
        - tempo
        - loki
      networks: [appnet]

    otel-collector:
      image: otel/opentelemetry-collector-contrib
      container_name: otel-collector
      volumes:
        - ./observability/otel-collector.yml:/etc/otel-collector-config.yml
      command: ["--config=/etc/otel-collector-config.yml"]
      ports:
        - "4317:4317"
        - "4318:4318"
        - "9464:9464"
      networks: [appnet]

    loki:
      image: grafana/loki:3.0.0
      container_name: loki
      ports:
        - "3100:3100"
      volumes:
        - ./observability/loki/loki-data:/tmp/loki
        - ./observability/loki/loki.yml:/etc/loki/loki.yml:ro
      command: -config.file=/etc/loki/loki.yml
      networks: [appnet]

    blog-api:
      build:
        context: ./backend/
        dockerfile: Dockerfile
        args:
          GIT_SHA: ${GIT_SHA}
      image: luisjrz96/blog-api:${GIT_SHA:-dev}
      environment:
        - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI=${SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI}
        - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
        - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
        - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
      extra_hosts:
        - "auth.localtest.me:host-gateway"
      restart: always
      ports:
        - "8080:8080"
      networks: [appnet]
      depends_on:
        - postgres
        - keycloak

  networks:
    appnet:
      driver: bridge